# alx-files_manager
A project to summarize the backend specialization training with ALX. The objective is to build a simple platform to upload and view files (users authenticate via a token, users can list all files, users can upload a new file, change the permission of a file, view the file and generate thumbnails for images).


## Setup environment

- node v12.x.x
- Ubuntu 18.04

## Tasks

- `utils.redis.js` file contains the `RedisClient` which is a class that  create a client to Redis such that any error of the redis client must be displayed in the console. There is a method `isAlive` that returns true when the connection to Redis is a success otherwise false. There are some asynchronous methods `get`, `set` and `del` that returns the Redis value for a stored key, set a key value pair with an expiration duration and deletes a Redis key.

```python
# Usage
import redisClient from './utils/redis';

(async () => {
    console.log(redisClient.isAlive());
    console.log(await redisClient.get('myKey'));
    await redisClient.set('myKey', 12, 5);
    console.log(await redisClient.get('myKey'));

    setTimeout(async () => {
        console.log(await redisClient.get('myKey'));
    }, 1000*10)
})();
```
```bash
bob@dylan:~$ npm run dev main.js
true
null
12
null
```
- `utils/db.js` file contains the class `DBClient` -- a class that creates a client to MongoDB that retrieves the host, port and database from the environment variables `DB_HOST`, `DB_PORT`, and `DB_DATABASE`. The class has the method `isAlive` which does the same function as that of `RedisClient`, two asynchronous methods `nbUsers` and `nbFiles` to return the number of documents in the collection of `users` and `files` respectively.

```python
# Usage
import dbClient from './utils/db';

const waitConnection = () => {
    return new Promise((resolve, reject) => {
        let i = 0;
        const repeatFct = async () => {
            await setTimeout(() => {
                i += 1;
                if (i >= 10) {
                    reject()
                }
                else if(!dbClient.isAlive()) {
                    repeatFct()
                }
                else {
                    resolve()
                }
            }, 1000);
        };
        repeatFct();
    })
};

(async () => {
    console.log(dbClient.isAlive());
    await waitConnection();
    console.log(dbClient.isAlive());
    console.log(await dbClient.nbUsers());
    console.log(await dbClient.nbFiles());
})();
```
```bash
bob@dylan:~$ npm run dev main.js
false
true
4
30
```
- `server.js` creates an express server that listens on port 5000 if port is not set by the environment variable `PORT` and loads all routes from the file `routes/index.js`. The `routes/index.js` contains all endpoints of the API which are `GET /status` and `GET /stats` handled by `AppController.getStatus` and `AppController.getStats` respectively. The AppController class is contained within `controllers.AppController.js`. `GET /status` should return if Redis is alive and if the DB is alive too by using the 2 utils.
```bash
# Usage
# Terminal 1:
bob@dylan:~$ npm run start-server
Server running on port 5000
...
# Terminal 2:
bob@dylan:~$ curl 0.0.0.0:5000/status ; echo ""
{"redis":true,"db":true}
bob@dylan:~$ 
bob@dylan:~$ curl 0.0.0.0:5000/stats ; echo ""
{"users":4,"files":30}
bob@dylan:~$ 
```
- add a new endpoint to the `routes/index.js` file which is `POST /users` that will be handled by `UserControllers.postNew` inside `controllers/UsersController.js`. A new user is created with an email and password where missing email or password is handled with the appropriate status code and message. Already existing email should return an error too. The new user's password should be hased in `SHA1` and if successfully created return the object containing the email and id (autogenerated by MongoDB) with status 201.
```bash
# Usage
# Terminal 2:
bob@dylan:~$ curl 0.0.0.0:5000/users -XPOST -H "Content-Type: application/json" -d '{ "email": "bob@dylan.com", "password": "toto1234!" }' ; echo ""
{"id":"5f1e7d35c7ba06511e683b21","email":"bob@dylan.com"}
bob@dylan:~$ 
bob@dylan:~$ echo 'db.users.find()' | mongo files_manager
{ "_id" : ObjectId("5f1e7d35c7ba06511e683b21"), "email" : "bob@dylan.com", "password" : "89cad29e3ebc1035b29b1478a8e70854f25fa2b2" }
bob@dylan:~$ 
bob@dylan:~$ 
bob@dylan:~$ curl 0.0.0.0:5000/users -XPOST -H "Content-Type: application/json" -d '{ "email": "bob@dylan.com", "password": "toto1234!" }' ; echo ""
{"error":"Already exist"}
bob@dylan:~$ 
bob@dylan:~$ curl 0.0.0.0:5000/users -XPOST -H "Content-Type: application/json" -d '{ "email": "bob@dylan.com" }' ; echo ""
{"error":"Missing password"}
bob@dylan:~$ 
```
- add three endpoints `GET /connect`, `GET /disconnect` and `GET /users/me` handled by the following `AuthController.getConnect`, `AuthController.getDisconnect` and `UsersController.getMe` in the `controllers/AuthController.js` and `controllers.UsersController.js` files respectively. The endpoint `GET /connect` should signin the user by generating a new authentication token using basic auth (Base64 of the email and password) passed in the request header `Authorization`. With each request find the associated email, if no email is found, handle appropriately (return `Unauthorized` error) with the status code 401, otherwise generate a random string using `uuidv4` as token, create a key `auth_<token>`, use the key for storing the user ID for 24 hours in Redis and return the token as `{ "token": "155342df-2399-41da-9e8c-458b6ac52a0c" }` with a status code 200. This token will be accessed by every authenticated endpoints of our API in the request header `X-Token`. The `GET /disconnect` endpoint should signout the user based on the token--it retrives the user based on the token, if not found returns an error `Unauthorized` with the status code 401 otherwise, deletes the token in Redis and returns nothing with a status code 204. Lastly, the `GET /users/me` endpoint should retrive the user base on the token used, if not found, returns an error `Unauthorized` with a status code 401 otherwise, returns the object `email` and `id` only.
```bash
# Usage:
# Terminal 2
bob@dylan:~$ curl 0.0.0.0:5000/connect -H "Authorization: Basic Ym9iQGR5bGFuLmNvbTp0b3RvMTIzNCE=" ; echo ""
{"token":"031bffac-3edc-4e51-aaae-1c121317da8a"}
bob@dylan:~$ 
bob@dylan:~$ curl 0.0.0.0:5000/users/me -H "X-Token: 031bffac-3edc-4e51-aaae-1c121317da8a" ; echo ""
{"id":"5f1e7cda04a394508232559d","email":"bob@dylan.com"}
bob@dylan:~$ 
bob@dylan:~$ curl 0.0.0.0:5000/disconnect -H "X-Token: 031bffac-3edc-4e51-aaae-1c121317da8a" ; echo ""

bob@dylan:~$ curl 0.0.0.0:5000/users/me -H "X-Token: 031bffac-3edc-4e51-aaae-1c121317da8a" ; echo ""
{"error":"Unauthorized"}
bob@dylan:~$ 
```
- add the endpoint `POST /files` handled by `FilesController.postUpload` in the `controllers/FilesController.js`. The endpoint should create a new file in DB and in disk. The steps taken are as follows; retrieves a user based on the token, if not found, handles appropriately with an `Unauthorized` error and status code 401, otherwise, creates a file given the `name`, `type`, `parentId`(optional), `isPublic`(optional) and `data`(`type=file|image`). If the name or type or data abd type is not a `folder` handle as an error appropriatedly. If `parentId` is set, but no file is present in DB for this `parentId`, handle as an error with a status code 400 otherwise, if present but not of type `folder`, handle as an error with status code 400. The `data` is stored as Base64; the user ID should be added to the document saved in the DBand if the parent is a folder, add the new file document in the DB and return the new file with a status code 201. However when there is no `parentId` set, all files will be stored locally in a folder (created automatically if not present) -- relative path is given by the environment variable `FOLDER_PATH` or `/tmp/files_manager`. The local path to the file should use UUID as the filename and then stored in the collection `files` with the attributes: `userId`, `name`, `type`, `isPublic`, `parentId` and `localPath`.
```bash
# Usage:
Terminal 2
bob@dylan:~$ curl 0.0.0.0:5000/connect -H "Authorization: Basic Ym9iQGR5bGFuLmNvbTp0b3RvMTIzNCE=" ; echo ""
{"token":"f21fb953-16f9-46ed-8d9c-84c6450ec80f"}
bob@dylan:~$ 
bob@dylan:~$ curl -XPOST 0.0.0.0:5000/files -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" -H "Content-Type: application/json" -d '{ "name": "myText.txt", "type": "file", "data": "SGVsbG8gV2Vic3RhY2shCg==" }' ; echo ""
{"id":"5f1e879ec7ba06511e683b22","userId":"5f1e7cda04a394508232559d","name":"myText.txt","type":"file","isPublic":false,"parentId":0}
bob@dylan:~$
bob@dylan:~$ ls /tmp/files_manager/
2a1f4fc3-687b-491a-a3d2-5808a02942c9
bob@dylan:~$
bob@dylan:~$ cat /tmp/files_manager/2a1f4fc3-687b-491a-a3d2-5808a02942c9 
Hello Webstack!
bob@dylan:~$
bob@dylan:~$ curl -XPOST 0.0.0.0:5000/files -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" -H "Content-Type: application/json" -d '{ "name": "images", "type": "folder" }' ; echo ""
{"id":"5f1e881cc7ba06511e683b23","userId":"5f1e7cda04a394508232559d","name":"images","type":"folder","isPublic":false,"parentId":0}
bob@dylan:~$
bob@dylan:~$ cat image_upload.py
import base64
import requests
import sys

file_path = sys.argv[1]
file_name = file_path.split('/')[-1]

file_encoded = None
with open(file_path, "rb") as image_file:
    file_encoded = base64.b64encode(image_file.read()).decode('utf-8')

r_json = { 'name': file_name, 'type': 'image', 'isPublic': True, 'data': file_encoded, 'parentId': sys.argv[3] }
r_headers = { 'X-Token': sys.argv[2] }

r = requests.post("http://0.0.0.0:5000/files", json=r_json, headers=r_headers)
print(r.json())

bob@dylan:~$
bob@dylan:~$ python image_upload.py image.png f21fb953-16f9-46ed-8d9c-84c6450ec80f 5f1e881cc7ba06511e683b23
{'id': '5f1e8896c7ba06511e683b25', 'userId': '5f1e7cda04a394508232559d', 'name': 'image.png', 'type': 'image', 'isPublic': True, 'parentId': '5f1e881cc7ba06511e683b23'}
bob@dylan:~$
bob@dylan:~$ echo 'db.files.find()' | mongo files_manager
{ "_id" : ObjectId("5f1e881cc7ba06511e683b23"), "userId" : ObjectId("5f1e7cda04a394508232559d"), "name" : "images", "type" : "folder", "parentId" : "0" }
{ "_id" : ObjectId("5f1e879ec7ba06511e683b22"), "userId" : ObjectId("5f1e7cda04a394508232559d"), "name" : "myText.txt", "type" : "file", "parentId" : "0", "isPublic" : false, "localPath" : "/tmp/files_manager/2a1f4fc3-687b-491a-a3d2-5808a02942c9" }
{ "_id" : ObjectId("5f1e8896c7ba06511e683b25"), "userId" : ObjectId("5f1e7cda04a394508232559d"), "name" : "image.png", "type" : "image", "parentId" : ObjectId("5f1e881cc7ba06511e683b23"), "isPublic" : true, "localPath" : "/tmp/files_manager/51997b88-5c42-42c2-901e-e7f4e71bdc47" }
bob@dylan:~$
bob@dylan:~$ ls /tmp/files_manager/
2a1f4fc3-687b-491a-a3d2-5808a02942c9   51997b88-5c42-42c2-901e-e7f4e71bdc47
bob@dylan:~$
```
- add two endpoints `GET /files/:id` and `GET /files` handled by `FilesController.getShow` and `FilesController.getIndex` respectively in the `controllers/FilesController.js` file. the `GET /files/:id` endpoint should retrieve the file document based on the ID -- as before the authorization is determined if request token is available and user exist otherwise handle as before. If no file document is linked to the user and the ID return error `Not found` with the status code 404, otherwise return the file document. The `GET /files` endpoint shoiuld retrieve all users file document for a specific `parentId` and with pagination -- authorize as before and handle error appropriately. Given the query params `parentId` and `page` return the list of file document. If `parentId` is not linked to any user folder return empty list and it is set to 0 by default. Pagination is set to a max of 20 items per page (`page` query param starts at 0) and pagination should be done directly by the `aggregate` call of MongoDB.
```bash
# Usage:
# Terminal 2
bob@dylan:~$ curl 0.0.0.0:5000/connect -H "Authorization: Basic Ym9iQGR5bGFuLmNvbTp0b3RvMTIzNCE=" ; echo ""
{"token":"f21fb953-16f9-46ed-8d9c-84c6450ec80f"}
bob@dylan:~$ 
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
[{"id":"5f1e879ec7ba06511e683b22","userId":"5f1e7cda04a394508232559d","name":"myText.txt","type":"file","isPublic":false,"parentId":0},{"id":"5f1e881cc7ba06511e683b23","userId":"5f1e7cda04a394508232559d","name":"images","type":"folder","isPublic":false,"parentId":0},{"id":"5f1e8896c7ba06511e683b25","userId":"5f1e7cda04a394508232559d","name":"image.png","type":"image","isPublic":true,"parentId":"5f1e881cc7ba06511e683b23"}]
bob@dylan:~$
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files?parentId=5f1e881cc7ba06511e683b23 -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
[{"id":"5f1e8896c7ba06511e683b25","userId":"5f1e7cda04a394508232559d","name":"image.png","type":"image","isPublic":true,"parentId":"5f1e881cc7ba06511e683b23"}]
bob@dylan:~$
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files/5f1e8896c7ba06511e683b25 -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
{"id":"5f1e8896c7ba06511e683b25","userId":"5f1e7cda04a394508232559d","name":"image.png","type":"image","isPublic":true,"parentId":"5f1e881cc7ba06511e683b23"}
bob@dylan:~$
```
- add two endpoints `PUT /files/:id/publish` and `PUT /files/:id/unpublish` handled by `FilesController.putPublish` and `FilesController.putUnpublish` respectively in the `controller/FilesController.js`. `PUT /files/:id/publish` endpoint should set `isPublic` to true on the file document based on the ID -- authorize request as usual and handle errors, if no file is linked to the user and the ID parameter retunr the error `Not found` with a status code 404, otherwise update teh value of `isPublic` to true and return the file document with a status code 200. `PUT /files/:id/unpublish` endpoint should set `isPublic` to false based on the ID. As usual authorise the request, then if no file is found linked ot the user and ID parameter return the error `Not found` with status code `404` otherwise update the value of `isPublic` to false and return the file document with the status code 200.
```bash
# Usage:
# Terminal 2
bob@dylan:~$ curl 0.0.0.0:5000/connect -H "Authorization: Basic Ym9iQGR5bGFuLmNvbTp0b3RvMTIzNCE=" ; echo ""
{"token":"f21fb953-16f9-46ed-8d9c-84c6450ec80f"}
bob@dylan:~$ 
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files/5f1e8896c7ba06511e683b25 -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
{"id":"5f1e8896c7ba06511e683b25","userId":"5f1e7cda04a394508232559d","name":"image.png","type":"image","isPublic":false,"parentId":"5f1e881cc7ba06511e683b23"}
bob@dylan:~$
bob@dylan:~$ curl -XPUT 0.0.0.0:5000/files/5f1e8896c7ba06511e683b25/publish -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
{"id":"5f1e8896c7ba06511e683b25","userId":"5f1e7cda04a394508232559d","name":"image.png","type":"image","isPublic":true,"parentId":"5f1e881cc7ba06511e683b23"}
bob@dylan:~$ 
bob@dylan:~$ curl -XPUT 0.0.0.0:5000/files/5f1e8896c7ba06511e683b25/unpublish -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
{"id":"5f1e8896c7ba06511e683b25","userId":"5f1e7cda04a394508232559d","name":"image.png","type":"image","isPublic":false,"parentId":"5f1e881cc7ba06511e683b23"}
bob@dylan:~$ 
```
- add one endpoint `GET /files/:id/data` handled by `FilesController.getFile` in the `controllers/FilesController.js` file. The endpoint should return the content of the file document based on the ID. If no file is linked to the ID parameter return an error `Not found` with status code 404; if the file document (folder or file) is not public (`isPublic`: false) and no user authenticate or not owner of the file, return an error `Not found` with a status code 404; if the type of the file document is `folder`, return an error `A folder doesn't have content` with a status code 400; if the file isn not locally present, return error `Not found` with status code 404 otherwise using the `mime-types` module, get the MIME-type based on the name of the file and retunr the content of the file with the correct MIME-type.
```bash
# Usage:
# Terminal 2
bob@dylan:~$ curl 0.0.0.0:5000/connect -H "Authorization: Basic Ym9iQGR5bGFuLmNvbTp0b3RvMTIzNCE=" ; echo ""
{"token":"f21fb953-16f9-46ed-8d9c-84c6450ec80f"}
bob@dylan:~$ 
bob@dylan:~$ curl -XPUT 0.0.0.0:5000/files/5f1e879ec7ba06511e683b22/unpublish -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
{"id":"5f1e879ec7ba06511e683b22","userId":"5f1e7cda04a394508232559d","name":"myText.txt","type":"file","isPublic":false,"parentId":0}
bob@dylan:~$ 
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files/5f1e879ec7ba06511e683b22/data -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
Hello Webstack!

bob@dylan:~$ curl -XGET 0.0.0.0:5000/files/5f1e879ec7ba06511e683b22/data ; echo ""
{"error":"Not found"}
bob@dylan:~$ 
bob@dylan:~$ curl -XPUT 0.0.0.0:5000/files/5f1e879ec7ba06511e683b22/publish -H "X-Token: f21fb953-16f9-46ed-8d9c-84c6450ec80f" ; echo ""
{"id":"5f1e879ec7ba06511e683b22","userId":"5f1e7cda04a394508232559d","name":"myText.txt","type":"file","isPublic":true,"parentId":0}
bob@dylan:~$ 
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files/5f1e879ec7ba06511e683b22/data ; echo ""
Hello Webstack!

bob@dylan:~$
```
- update the `POST /files` endpoint to start a background process for generating thumbnails for a file type `image`. Create a `Bull` queue `fileQueue` and add a job to this queue with the `userId` and `fileId` when a new image is stored (in local and in DB). In the file `worker.js`, use the module `Bull` to create a queue `fileQueue` and process this queue -- if fileId is not present raise error `Missing fileId`; if userId is not present raise error `Missing userId`; if no document is found in DB based on the fieldId and userId raise error `File not found` and generate 3 thumbnails with width=500, 250 and 100 whcih should be stored on the same location of the original file by appending `_<width>` by using the `image-thumbnail` module. Update the endpoint `GET /files/:id/data` to accept a query parameter `size` that retrieves the correct local file if it exist otherwise return an error `Not found` with staus code 404.
```bash
# Usage
# Terminal 3: (start the worker)
bob@dylan:~$ npm run start-worker
...

# Terminal 2
bob@dylan:~$ curl 0.0.0.0:5000/connect -H "Authorization: Basic Ym9iQGR5bGFuLmNvbTp0b3RvMTIzNCE=" ; echo ""
{"token":"f21fb953-16f9-46ed-8d9c-84c6450ec80f"}
bob@dylan:~$ 
bob@dylan:~$ python image_upload.py image.png f21fb953-16f9-46ed-8d9c-84c6450ec80f 5f1e881cc7ba06511e683b23
{'id': '5f1e8896c7ba06511e683b25', 'userId': '5f1e7cda04a394508232559d', 'name': 'image.png', 'type': 'image', 'isPublic': True, 'parentId': '5f1e881cc7ba06511e683b23'}
bob@dylan:~$ ls /tmp/files_manager/
2a1f4fc3-687b-491a-a3d2-5808a02942c9   51997b88-5c42-42c2-901e-e7f4e71bdc47   6dc53397-8491-4b7c-8273-f748b1a031cb   6dc53397-8491-4b7c-8273-f748b1a031cb_100   6dc53397-8491-4b7c-8273-f748b1a031cb_250    6dc53397-8491-4b7c-8273-f748b1a031cb_500
bob@dylan:~$ 
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files/5f1e8896c7ba06511e683b25/data -so new_image.png ; file new_image.png
new_image.png: PNG image data, 471 x 512, 8-bit/color RGBA, non-interlaced
bob@dylan:~$ 
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files/5f1e8896c7ba06511e683b25/data?size=100 -so new_image.png ; file new_image.png
new_image.png: PNG image data, 100 x 109, 8-bit/color RGBA, non-interlaced
bob@dylan:~$ 
bob@dylan:~$ curl -XGET 0.0.0.0:5000/files/5f1e8896c7ba06511e683b25/data?size=250 -so new_image.png ; file new_image.png
new_image.png: PNG image data, 250 x 272, 8-bit/color RGBA, non-interlaced
bob@dylan:~$
```
-
